<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Jeddah Route Finder</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    #controls {
      position: absolute; top: 10px; left: 10px; z-index: 9999;
      background: white; padding: 10px; border-radius: 6px;
    }
    .highlight { background: yellow; }
  </style>
</head>
<body>
<div id="controls">
  <input type="file" id="fileInput" multiple><br><br>
  <button id="startBtn">Select Start</button>
  <button id="endBtn">Select End</button>
  <button id="routeBtn">Find Route</button>
</div>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([21.65, 39.2], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
}).addTo(map);

let graph = {}, features = [], startPoint = null, endPoint = null;
let startMarker = null, endMarker = null;

function addToGraph(coords, id) {
  graph[id] = graph[id] || [];
  graph[id].push(coords);
}

function toId(coord) {
  return coord[0].toFixed(6) + "," + coord[1].toFixed(6);
}

function distance(a, b) {
  const dx = a[0] - b[0], dy = a[1] - b[1];
  return Math.sqrt(dx*dx + dy*dy);
}

function dijkstra(start, end) {
  let dist = {}, prev = {}, Q = new Set(Object.keys(graph));
  for (let v of Q) dist[v] = Infinity;
  dist[start] = 0;

  while (Q.size > 0) {
    let u = [...Q].reduce((a, b) => dist[a] < dist[b] ? a : b);
    Q.delete(u);
    if (u === end) break;
    for (let v of graph[u]) {
      let alt = dist[u] + distance(u.split(',').map(Number), v);
      let vid = toId(v);
      if (alt < dist[vid]) {
        dist[vid] = alt;
        prev[vid] = u;
      }
    }
  }

  let path = [], u = end;
  while (u) {
    path.unshift(u);
    u = prev[u];
  }
  return path.map(p => p.split(',').map(Number));
}

function handleGeoJSON(data) {
  L.geoJSON(data, {
    onEachFeature: function (feature) {
      let coords = feature.geometry.coordinates;
      if (feature.geometry.type === "LineString") {
        for (let i = 0; i < coords.length - 1; i++) {
          let a = coords[i], b = coords[i+1];
          addToGraph(b, toId(a));
          addToGraph(a, toId(b));
        }
      }
    }
  }).addTo(map);
}

function getClosestNode(latlng) {
  let min = Infinity, closest = null;
  for (let id in graph) {
    let coord = id.split(',').map(Number);
    let d = distance([latlng.lat, latlng.lng], coord);
    if (d < min) { min = d; closest = id; }
  }
  return closest;
}

document.getElementById('fileInput').addEventListener('change', function(e) {
  for (let file of e.target.files) {
    let reader = new FileReader();
    reader.onload = function(e) {
      let geo = JSON.parse(e.target.result);
      handleGeoJSON(geo);
    };
    reader.readAsText(file);
  }
});

document.getElementById('startBtn').onclick = function() {
  map.once('click', function(e) {
    startPoint = e.latlng;
    if (startMarker) map.removeLayer(startMarker);
    startMarker = L.marker(e.latlng, {color: 'green'}).addTo(map).bindPopup("Start").openPopup();
  });
};

document.getElementById('endBtn').onclick = function() {
  map.once('click', function(e) {
    endPoint = e.latlng;
    if (endMarker) map.removeLayer(endMarker);
    endMarker = L.marker(e.latlng, {color: 'red'}).addTo(map).bindPopup("End").openPopup();
  });
};

document.getElementById('routeBtn').onclick = function() {
  if (!startPoint || !endPoint) return alert("Select start and end points first.");
  let startId = getClosestNode(startPoint);
  let endId = getClosestNode(endPoint);
  let path = dijkstra(startId, endId);
  if (path.length < 2) return alert("No path found.");
  L.polyline(path, {color: 'blue'}).addTo(map);
};
</script>
</body>
</html>
