<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Jeddah Route Finder (High Precision)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body, #map { height: 100%; margin: 0; }
    #controls {
      position: absolute; top: 10px; left: 10px; z-index: 9999;
      background: white; padding: 10px; border-radius: 6px;
    }
    #steps {
      position: absolute; bottom: 10px; left: 10px; z-index: 9999;
      background: white; padding: 10px; border-radius: 6px;
      max-height: 200px; overflow-y: auto; font-size: 14px;
    }
    #uploadStatus {
      margin-top: 10px;
      font-size: 13px;
    }
    #progressBar {
      width: 100%;
      background: #eee;
      border-radius: 4px;
      height: 10px;
      margin-top: 5px;
    }
    #progressInner {
      height: 10px;
      background: #4caf50;
      width: 0%;
      border-radius: 4px;
    }
  </style>
</head>
<body>
<div id="controls">
  <input type="file" id="fileInput" multiple><br><br>
  <div id="uploadStatus">No file uploaded.</div>
  <div id="progressBar"><div id="progressInner"></div></div><br>
  <button id="startBtn">Add Start Point</button>
  <button id="waypointBtn">Add Waypoint</button>
  <button id="endBtn">Add End Point</button>
  <button id="routeBtn">Find Route</button>
  <button id="resetBtn">Reset Route</button>
  <button id="blockBtn">ðŸ”§ Toggle Block Mode</button>
  <button id="debugBtn">Toggle Graph Debug</button>
</div>
<div id="steps"><strong>Steps:</strong><ul id="instructions"></ul></div>
<div id="map"></div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([21.65, 39.2], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19
}).addTo(map);

let graph = {}, allCoords = new Set();
let blockMode = false, blockedEdges = new Set(), roadPolylines = [];

function toId(c) { return c[0].toFixed(6)+","+c[1].toFixed(6); }
function distance(a, b) { const dx=a[0]-b[0], dy=a[1]-b[1]; return Math.sqrt(dx*dx + dy*dy); }
function findNearby(c) {
  let min=Infinity, best=null;
  for (let id of allCoords) {
    let pt = id.split(',').map(Number);
    let d = distance(c, pt);
    if (d < min && d < 0.0005) { min = d; best = pt; }
  }
  return best;
}
function addToGraph(a, b) {
  const aid = toId(a), bid = toId(b);
  allCoords.add(aid); allCoords.add(bid);
  graph[aid] = graph[aid] || [];
  graph[aid].push({coord: b, id: bid});
  graph[bid] = graph[bid] || [];
  graph[bid].push({coord: a, id: aid});
}

function handleGeoJSON(data) {
  L.geoJSON(data, {
    onEachFeature: function (feature) {
      let coords = feature.geometry.coordinates;
      if (feature.geometry.type === "LineString") {
        let points = coords.map(c => [c[1], c[0]]);
        for (let i = 0; i < points.length - 1; i++) {
          let a = findNearby(points[i]) || points[i];
          let b = findNearby(points[i + 1]) || points[i + 1];
          addToGraph(a, b);
          const poly = L.polyline([a, b], { color: '#444', weight: 3 }).addTo(map);
          roadPolylines.push(poly);
          poly.on('click', function () {
            if (!blockMode) return;
            const id1 = toId(a), id2 = toId(b);
            blockedEdges.add(`${id1}|${id2}`);
            blockedEdges.add(`${id2}|${id1}`);
            poly.setStyle({ color: 'black', dashArray: '5,5' });
          });
        }
      }
    }
  });
}

function updateProgress(percent, message) {
  document.getElementById('progressInner').style.width = percent + '%';
  document.getElementById('uploadStatus').innerText = message;
}

document.getElementById('fileInput').addEventListener('change', function (e) {
  let totalFiles = e.target.files.length;
  let loadedFiles = 0;
  const startTime = Date.now();

  for (let file of e.target.files) {
    let reader = new FileReader();

    reader.onprogress = function (event) {
      if (event.lengthComputable) {
        let percent = Math.round((event.loaded / event.total) * 100);
        updateProgress(percent, `Uploading: ${file.name} (${percent}%)`);
      }
    };

    reader.onloadstart = function () {
      updateProgress(0, `Starting upload: ${file.name}`);
    };

    reader.onload = function (e) {
      let geo = JSON.parse(e.target.result);
      handleGeoJSON(geo);
      loadedFiles++;
      const timeElapsed = ((Date.now() - startTime) / 1000).toFixed(2);
      updateProgress(100, `Uploaded ${loadedFiles}/${totalFiles} file(s) in ${timeElapsed}s.`);
    };

    reader.onerror = function () {
      updateProgress(0, `Error reading file: ${file.name}`);
    };

    reader.readAsText(file);
  }
});
</script>
</body>
</html>
